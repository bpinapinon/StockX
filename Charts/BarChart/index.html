<!DOCTYPE html>

<!--The <head> element holds a set of data that describes and gives information
     about other data re: the page: such as the 
    encoding (<meta charset="UTF-8"> specifies the UTF-8 as a charset-->
<head>
	<meta charset="UTF-8">
    <title>Sneaker Bar Chart</title>
    
    <!--<link rel="stylesheet" href="reset.css">-->
    <!--Using the <link rel="stylesheet" ...> we can load CSS files, fonts and other resources. Those can be local ones 
     or from the internet-->
    <link rel="stylesheet" type = 'text/css' href="stylesheet.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Allerta+Stencil">
</head>


<body>
    <!--<h>s used for the headings (titles)-->
    <h1>Sneaker Dynamic Bar Chart</h1>

    <!--<p> = paragraphs, <select> elements = (dropdowns)-->  
    <p class = "axes_dropdown">X-Axis Variable
        <select name="x_axis" id="x_axis"></select>
    </p>

    <p class = "axes_dropdown">Y-Axis Variable 
        <select name="y_axis" id="y_axis"></select>
    </p>

    <container class="g3" style="height: 700px; width: 1200px;"></container>
    <!--<div>s are used to group other elements-->
    <div id="infobox"> Select .csv file: </div>
        
    <div id="inputs" class="clearfix">
        
        <!--is the button to upload files-->
        <input type="file" id="files" name="files[]" multiple />    
    </div>

    <!--<hr>=hoizontal lines used to separate-->
    <hr />

    <!--the <output> element to display the result of an interest rate calculation, based
    on user input. The <output> element is also used to display the result of the 
    range slider as the user adjusts the interest rate.-->
    <output id="list"></output>

    <hr />

    <!--<table> for tables-->
    <table id="contents" style="width:100%; height:400px;" border></table>

    <!--How can you write javascript code in HTML doc? Answer: In HTML, JavaScript code must be 
        inserted between <script> and </script> tags-->
    <!--the <script> element we can load JavaScript files-->
    <!--What is a jquery? is a big javascript library written by other people.
    You can call a jquery library to make something happen on your page--> 
    
    <!--This D3js below provides code to assist in creating an interactive graph. Found on this link https://d3js.org/ -->
    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="jquery.js"></script>

    <!--This jquery library is used to create a CSV parser. Found on this link http://evanplaice.github.io/jquery-csv/-->
    <script src="http://evanplaice.github.io/jquery-csv/src/jquery.csv.min.js"></script>
    <script>
        
        //Constants- naming a variable
        //note to me- i dont think this is being used-comment out for now
        var MAX_LABEL_LENGTH = 30;
        var i = 1;
        var data = [];

        //D3 is another javascript library that is used for graphs and charts
        //This line of code reads intial data from CSV file
        d3.csv("Sneaker_Bar.csv", type, function(error, _data) {

            // debugging purposes, you can use the console.log() method to display data
            console.log(">>", _data);
            data = _data;
        // dataLoaded(data);
        });
        
        //Code below is being used for potential reference. Not being used.
        //note to me- i dont think this is being used-comment out for now
        //function type(d) {
        //   d.Label = d.Model;
        //   d.ItemNumber =  "" + i;
        //    i++;
        //  return d;
        //}
        //function getRandomArbitrary(min, max) {
        //    return Math.round(Math.random() * (max - min) + min);
        //}
        
        function dataLoaded(data) {
            var x_Axis_Labels = Array();
            var y_Axis_Labels = Array();
            
             // Collect in the x_Axis_Labels array the Headers from the CSV
            // Those are used to be displayed in the dropdown below
            if(data.length > 0)
            {
                // Get the first element from
                var firstNode = data[0];

                // Iterate its keys (labels)
                for (var k in firstNode) {
                    if (firstNode.hasOwnProperty(k)) {

                        // Collect them in the array
                        x_Axis_Labels.push(k);

                        // If the current label has a numeric value, append it in the other dropdown
                        if(!isNaN(firstNode[k]))
                        {
                            y_Axis_Labels.push(k);
                        }
                        console.log("<" + k + " = " + firstNode[k] + "> ");
                    }
                }
            }
            // For each label, append an <option> in the <select> dropdown
            $.each(x_Axis_Labels, function(key, value) {
                $('#x_axis')
                    .append($("<option></option>")
                        .attr("value",value)
                        .text(value));
            });
            var isFirst = true;
            // In the same way, append the Y values in the other dropdown
            $.each(y_Axis_Labels, function(key, value) {
                $('#y_axis')
                    .append($(isFirst ? "<option selected></option>" :  "<option> </option>")
                        .attr("value",value)
                        .text(value));
            });

            // At this point the dropdowns contain:
            // The X dropdown: all the labels
            // The Y dropdown: the labels with numeric values
            console.log("X Axis: ", x_Axis_Labels);
            console.log("Y Axis: ", y_Axis_Labels);

            // Constants for the graphics of the chart (margins, height, width, sizes etc)
            var margin =  {top: 20, right: 10, bottom: 20, left: 40};
            var marginOverview = {top: 30, right: 10, bottom: 20, left: 40};
            var selectorHeight = 40;
            var width = 1200 - margin.left - margin.right;
            var height = 700 - margin.top - margin.bottom - selectorHeight;
            var heightOverview = 80 - marginOverview.top - marginOverview.bottom;
            
            // When we change the dropdown values, call the `createChart`
            $("#x_axis").change(function () {
                createChart();
            });
            $("#y_axis").change(function () {
                createChart();
            });

            // The createChart is called as well, right now, below (after the createChart definition)
            // (at the end of this function)
            function createChart()
            {
                // Remove the <svg> elements if any
                d3.selectAll("svg").remove();
                
                // Get the selected values from the X and Y dropdowns
                var selectedItem = document.getElementById('x_axis').value;
                var selectedYAxis = document.getElementById('y_axis').value;
                // Get the max length
                var maxLength = d3.max(data.map(
                    function(d)
                    {
                        return d[selectedItem].length
                    }
                    )
                )
                // Define the barWidth depending on the maxLength
                var barWidth = maxLength * 18;
                // Calculate the number of bars
                // (divide the width to bar width)
                var numBars = Math.round(width/barWidth);
                // Check if the scroll should be displayed
                var isScrollDisplayed = barWidth * data.length > width;


                console.log(isScrollDisplayed)

                // Build the x and y scales
                var xscale = d3.scale.ordinal()
                    .domain(data.slice(0,numBars).map(function (d)
                    {
                        return d[selectedItem];
                    }))
                    // The range will be between 0 and width
                    .rangeBands([0, width], .2);
                
                // In a similar way, the Y axis   
                var yscale = d3.scale.linear()
                    .domain([0, d3.max(data, function (d)
                    {
                        return +d[selectedYAxis];
                    })])

                    // Define the range
                    .range([height, 0]);

                 // Set up the orientation and the user interface
                var xAxis  = d3.svg.axis().scale(xscale).orient("bottom");
                var yAxis  = d3.svg.axis().scale(yscale).orient("left");

                // At this point we start modifying the page content
                // By selecting the <container> element (a custom element as mentioned in Introduction)
                var svg = d3.select("container")
                    // Append an <svg> element to it
                    .append("svg")
                    // Set the size
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom + selectorHeight);
                
                    // Create a group (<g> element)—like divs for HTML, <g> are used for SVG
                var diagram = svg.append("g")
                    // Set the margins, using transform - translate
                    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                // Append the x axis
                diagram.append("g")
                    .attr("class", "x axis")
                    .attr("transform", "translate(0, " + height + ")")
                    .text("XAxis")
                    .call(xAxis) ;

                // Append the y axis
                diagram.append("g")
                    .attr("class", "y axis")

                    .call(yAxis);

                // Create the tooltip
                var div = d3.select("body")
                    .append("div")
                    .attr("class", "tooltip")
                    .style("opacity", 0);

                // Create the bars container
                var bars = diagram.append("g").attr("class", "g3");
                
                // Create rectangles in the bars container
                bars.selectAll("rect")

                    // The value of each bar should be the selcted item
                    .data(data.slice(0, numBars), function (d)
                    {
                        return d[selectedItem];
                    })

                    // Append the <rect> element (rectangle)
                    .enter().append("rect")
                    // Set its class
                    .attr("class", "bar")
                    // Set the x attribute (dinamically computed)
                    .attr("x", function (d)
                    {
                        return xscale(d[selectedItem]);
                    })
                    // Set the y attribute (dinamically computed)
                    .attr("y", function (d)
                    {
                        return yscale(+d[selectedYAxis]);
                    })
                    // Set the width (computed as well)
                    .attr("width", xscale.rangeBand())
                    // Set the height (computed too)
                    .attr("height", function (d)
                    {
                        return height - yscale(+d[selectedYAxis]);
                    })
                    // Tooltip handlers (show the tooltip on mouseenter/touchstart 
                    //and hide it on mouseleave/touchstop)
                    .on("mouseenter", showTooltip)
                    .on("touchstart", showTooltip)
                    .on("mouseleave", hideTooltip)
                    .on("touchend", hideTooltip)
                    // On mouse move, call the mouse move update the position of the tooltip
                    .on("mousemove", mousemove);


                // This sets the left and top properties, settting the position of the
                // tooltip
                function mousemove(data) {
                    div

                        .style("left", (d3.event.pageX - 34) + "px")
                        .style("top", (d3.event.pageY - 12) + "px");
                }
                // Show the tooltip
                function showTooltip(data)
                {
                    // transparency

                    d3.select(this).transition()
                        .duration(200)
                        .style("opacity", .7);

                    // end transparency

                    // Set the opacity to 0.9
                    div.style("opacity", .9);

                    // Build the the HTML content
                    var _html = `<div class="tooltip-name">
                    <p><strong>${selectedItem} = ${data[selectedItem]}</div> ${selectedYAxis} =  ${data[selectedYAxis]} </strong></p>

                    `;
                    // Set the HTML content and set the positoin of the tooltip
                    div.html(_html)
                        .style("left", (d3.event.pageX + 25) + "px")
                        .style("top", (d3.event.pageY - 25) + "px");
                    _html = '';
                    for (var k in data) {
                        if (firstNode.hasOwnProperty(k)) {
                            _html += `<p> ${k} => ${data[k]} </p>`;
                        }
                    }
                    $('#infobox').html(_html);


                }
                
                // Hide the tooltip
                function hideTooltip(data)
                {
                    // transparency

                    d3.select(this).transition()
                        .duration(200)
                        .style("opacity", 1);


                    div.style("opacity", 0);
                }

                // If scroll should be displayed, build the navigator under the graph
                if (isScrollDisplayed)
                {
                    // Create the ordinal sclae (X)
                    var xOverview = d3.scale.ordinal()
                        .domain(data.map(function (d) { return d[selectedItem]; }))
                        .rangeBands([0, width], .2);
                    // and Y    
                    yOverview = d3.scale.linear().range([heightOverview, 0]);
                    yOverview.domain(yscale.domain());
                    
                    // Build the small bars
                    var subBars = diagram.selectAll('.subBar')
                        .data(data)
                    
                    // Here we create them
                    subBars.enter().append("rect")
                        .classed('subBar', true)
                        // Their height, width, x and y are computed
                        .attr({
                            height: function(d) {
                                return heightOverview - yOverview(+d[selectedYAxis]);
                            },
                            width: function(d) {
                                return xOverview.rangeBand()
                            },
                            x: function(d) {

                                return xOverview(d[selectedItem]);
                            },
                            y: function(d) {
                                return height + heightOverview + yOverview(+d[selectedYAxis])
                            }
                        })
                    // Create the scale
                    var displayed = d3.scale.quantize()
                        .domain([0, width])
                        .range(d3.range(data.length));
                    // Append the draggable rectangle
                    // (the bottom one which you use for horizontal scrolling)
                    diagram.append("rect")
                        .attr("transform", "translate(0, " + (height + margin.bottom) + ")")
                        .attr("class", "mover")
                        .attr("x", 0)
                        .attr("y", 0)
                        .attr("height", selectorHeight)
                        .attr("width", Math.round(parseFloat(numBars * width)/data.length))
                        .attr("pointer-events", "all")
                        .attr("cursor", "ew-resize")
                        .call(d3.behavior.drag().on("drag", display));
                }
                // line 396 to 460 is what makes the draggable fx work along the
                //sub-bars
                function display () {

                    // Get the position of the rectangle
                    var x = parseInt(d3.select(this).attr("x")),
                        nx = x + d3.event.dx,
                        w = parseInt(d3.select(this).attr("width")),
                        f, nf, new_data, rects;
                    
                    // Validate the nx
                    // What is nx? check this link https://github.com/nx-js/framework
                    if ( nx < 0 || nx + w > width ) return;
                    
                    // Update the user interface (UI)
                    //A user interface (UI) is a conduit between human and computer interaction
                    // – the space where a user will interact with a computer or machine to complete tasks
                    d3.select(this).attr("x", nx);

                    f = displayed(x);
                    nf = displayed(nx);

                    if ( f === nf ) return;

                    new_data = data.slice(nf, nf + numBars);

                    xscale.domain(new_data.map(
                        function (d)
                        {
                            return d[selectedItem];
                        }));
                    diagram.select(".x.axis").call(xAxis);

                    rects = bars.selectAll("rect")
                        .data(new_data, function (d)
                        {
                            return d[selectedItem];
                        });

                    rects.attr("x", function (d)
                    {
                        return xscale(d[selectedItem]);
                    });

    // 	  rects.attr("transform", function(d) { return "translate(" + xscale(d.label) + ",0)"; })

                    rects.enter().append("rect")
                        .attr("class", "bar")
                        .attr("x", function (d) { return xscale(d[selectedItem]); })
                        .attr("y", function (d) { return yscale(+d[selectedYAxis]); })
                        .attr("width", xscale.rangeBand())
                        .attr("height", function (d) { return height - yscale(+d[selectedYAxis]); });

                    rects.exit().remove();


                    bars.selectAll("rect").on("mouseenter", showTooltip)
                        .on("touchstart", showTooltip)
                        .on("mouseleave", hideTooltip)
                        .on("touchend", hideTooltip)
                        .on("mousemove", mousemove);

                };
            }
            // Call the createChart, as mentioned above
            createChart();
        } // data loaded ends

    </script>

    <script>

        //A page can't be manipulated safely until the document is "ready." 
        //jQuery detects this state of readiness for you. Code included 
        //inside $( document ).ready() will only run once the page Document 
        //Object Model (DOM) is ready for JavaScript code to execute 
        $(document).ready(function() {

            //Checks is API is available--if a FileReader exists(?)
            //The FileReader object lets web applications asynchronously read
            // the contents of files (or raw data buffers) stored on the user's computer
            if(isAPIAvailable()) {

                //Wait for the "change" event and call the handlefileselect function when
                // then select a file
                //The handleFileSelect function displays the file information and 
                //the printTable function reads the content and displays it
                $('#files').bind('change', handleFileSelect);
            }
        });

        // This defines the isAPIAvailable function
        // If the FileReader is not available, a message is displayed
        function isAPIAvailable() {

            // Check for the various File API support.
            if (window.File && window.FileReader && window.FileList && window.Blob) {
                // Great success! All the File APIs are supported.
                return true;
            } else {
                // source: File API availability - http://caniuse.com/#feat=fileapi
                // source: <output> availability - http://html5doctor.com/the-output-element/
                document.writeln('The HTML5 APIs used in this form are only available in the following browsers:<br />');
                // 6.0 File API & 13.0 <output>
                document.writeln(' - Google Chrome: 13.0 or later<br />');
                // 3.6 File API & 6.0 <output>
                document.writeln(' - Mozilla Firefox: 6.0 or later<br />');
                // 10.0 File API & 10.0 <output>
                document.writeln(' - Internet Explorer: Not supported (partial support expected in 10.0)<br />');
                // ? File API & 5.1 <output>
                document.writeln(' - Safari: Not supported<br />');
                // ? File API & 9.2 <output>
                document.writeln(' - Opera: Not supported');
                return false;
            }
        }
        
        //Another reminder > The handleFileSelect function displays the file
        // information and the printTable function reads the content and displays it
        function handleFileSelect(evt) {
            //// Get the file object
            var files = evt.target.files; // FileList object
            var file = files[0];

            // read the file metadata
            var output = ''
            output += '<span style="font-weight:bold;">' + escape(file.name) + '</span><br />\n';
            output += ' - FileType: ' + (file.type || 'n/a') + '<br />\n';
            output += ' - FileSize: ' + file.size + ' bytes<br />\n';
            output += ' - LastModified: ' + (file.lastModifiedDate ? file.lastModifiedDate.toLocaleDateString() : 'n/a') + '<br />\n';

            // read the file contents
            printTable(file);

            // post the results
            $('#list').append(output);
        }

        function printTable(file) {

            // Initialize the file reader (which will read the file)
            var reader = new FileReader();

            // Start reading the file content
            reader.readAsText(file);

            // once the file reading is complete, we need to parse:
            reader.onload = function(event){
                // The event object contains some metadata, including
                // the result itself

                // The event.target.result is the CSV data
                var csv = event.target.result;

                // Parse the CSV data 
                var data = $.csv.toArrays(csv);
                console.log(data);

                // We create the chart data here
                var chartData = Array();
                if(data.length > 0)
                {
                    // The Labels variable is the first row from the CSV file
                    // (the headers row)
                    var index = 0;
                    var Labels = data[0];

                    // Iterate the data and insert the objects into the chartData array
                    for(var row in data) {
                        if (index > 0) {
                            var newObj = {};

                            // Build the rows by iterating each item
                            newObj['No.'] = '' +index;
                            for (var item in data[row]) {

                                newObj[Labels[item]] = data[row][item];

                            }

                        chartData.push(newObj);
                    }
                        index++;
                    }
                }
                // This initializes the chart, check below
                dataLoaded(chartData);

                // Build the HTML table by simply iterating the data from the CSV file
                var html = '';
                for(var row in data) {
                    html += '<tr>\r\n';
                    for(var item in data[row]) {
                        html += '<td>' + data[row][item] + '</td>\r\n';
                    }
                    html += '</tr>\r\n';
                }
                $('#contents').html(html);
            };

            // If there is an error, make sure we catch it and display it to the user
            reader.onerror = function(){ alert('Unable to read ' + file.fileName); };
        }
    </script>